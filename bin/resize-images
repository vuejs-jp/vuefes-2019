#!/usr/bin/env bash

# Fail on unset variables and command errors
set -ue -o pipefail

# Prevent commands misbehaving due to locale differences
export LC_ALL=C

for file in `git diff --cached --name-status | \
  awk '$1 ~ /[AM]/ && tolower($2) ~ /src\/assets\/images\/staffs\/(?!@2x\/).+\.(jpe?g|png|gif|svg)$/ {print $2}'`
do
  echo コアスタッフの $file をリサイズします
  cat $file | ./node_modules/.bin/sharp \
    resize 155 155 > ${file}.new
  mv -f ${file}.new $file
  git add $file
done

for file in `git diff --cached --name-status | \
  awk '$1 ~ /[AM]/ && tolower($2) ~ /src\/assets\/images\/staffs\/@2x\/.+\.(jpe?g|png|gif|svg)$/ {print $2}'`
do
  echo コアスタッフ@2xの $file をリサイズします
  cat $file | ./node_modules/.bin/sharp \
    resize 310 310 > ${file}.new
  mv -f ${file}.new $file
  git add $file
done
